# åŒèŠ±é¡ºæ•°æ®è·å–æ¨¡å—

åŸºäºåŒèŠ±é¡ºiFinD APIçš„è‡ªåŠ¨åŒ–æ•°æ®è·å–å’ŒåŒæ­¥ç³»ç»Ÿï¼Œç”¨äºè¡¥é½é¾™è™æ¦œå’Œæ—¥çº¿æ•°æ®ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **é¾™è™æ¦œæ•°æ®è·å–**: è‡ªåŠ¨è·å–å¸­ä½æ•°æ®ã€äº¤æ˜“æµå‘æ•°æ®
- âœ… **æ—¥çº¿æ•°æ®è·å–**: æ”¯æŒå…¨å¸‚åœºè‚¡ç¥¨çš„OHLCVæ•°æ®å’ŒæŠ€æœ¯æŒ‡æ ‡
- âœ… **è‡ªåŠ¨åŒ–è°ƒåº¦**: æ¯å¤©æ™šä¸Š8:00è‡ªåŠ¨åŒæ­¥æœ€æ–°äº¤æ˜“æ•°æ®
- âœ… **å¢é‡æ›´æ–°**: æ™ºèƒ½è¯†åˆ«æ•°æ®ç¼ºå£ï¼Œåªè·å–ç¼ºå¤±çš„æ•°æ®
- âœ… **æ•°æ®åº“é›†æˆ**: è‡ªåŠ¨å†™å…¥Supabaseæ•°æ®åº“ï¼Œä¸ç°æœ‰ç³»ç»Ÿæ— ç¼é›†æˆ

### é«˜çº§ç‰¹æ€§
- ğŸ”„ **é‡è¯•æœºåˆ¶**: ç½‘ç»œå¼‚å¸¸è‡ªåŠ¨é‡è¯•ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
- ğŸ“Š **æ‰¹å¤„ç†ä¼˜åŒ–**: å¤§æ•°æ®é‡åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
- ğŸ“ˆ **å®æ—¶ç›‘æ§**: å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œæ‰§è¡ŒçŠ¶æ€è·Ÿè¸ª
- âš¡ **æ€§èƒ½ä¼˜åŒ–**: å¹¶è¡Œå¤„ç†å’Œè¯·æ±‚é¢‘ç‡æ§åˆ¶
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†**: ä¼˜é›…çš„å¼‚å¸¸å¤„ç†å’Œæ•°æ®éªŒè¯

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

### è½¯ä»¶ç¯å¢ƒ
- Python 3.8+
- åŒèŠ±é¡ºiFinDç»ˆç«¯ï¼ˆå·²å®‰è£…å¹¶æ¿€æ´»ï¼‰
- ç¨³å®šçš„ç½‘ç»œè¿æ¥

### ç¡¬ä»¶å»ºè®®
- å†…å­˜: 4GB+ï¼ˆå¤„ç†å¤§é‡å†å²æ•°æ®ï¼‰
- å­˜å‚¨: 1GB+ï¼ˆæ—¥å¿—å’Œç¼“å­˜æ–‡ä»¶ï¼‰
- ç½‘ç»œ: 10Mbps+ï¼ˆAPIæ•°æ®ä¼ è¾“ï¼‰

## ğŸ”§ å®‰è£…é…ç½®

### 1. ç¯å¢ƒå˜é‡è®¾ç½®

åˆ›å»º `.env` æ–‡ä»¶æˆ–è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡:

```bash
# åŒèŠ±é¡ºiFinDè´¦æˆ·
THS_USER_ID=ä½ çš„åŒèŠ±é¡ºç”¨æˆ·ID
THS_PASSWORD=ä½ çš„åŒèŠ±é¡ºå¯†ç 

# Supabaseæ•°æ®åº“
SUPABASE_URL=ä½ çš„Supabaseæ•°æ®åº“URL
SUPABASE_KEY=ä½ çš„Supabase APIå¯†é’¥
```

### 2. åŒèŠ±é¡ºiFinDé…ç½®

1. å®‰è£…åŒèŠ±é¡ºiFinDç»ˆç«¯
2. ç™»å½•å¹¶æ¿€æ´»APIæƒé™
3. å®‰è£…PythonåŒ…:
   ```bash
   # ä»iFinDç»ˆç«¯å®‰è£…ç›®å½•å¤åˆ¶iFinDPyåŒ…
   # é€šå¸¸ä½äº: C:\iFinD\API\Python\
   ```

### 3. ä¾èµ–åŒ…å®‰è£…

```bash
pip install pandas numpy supabase schedule python-dotenv
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
data_service/
â”œâ”€â”€ tonghuashun_client.py    # åŒèŠ±é¡ºAPIå®¢æˆ·ç«¯
â”œâ”€â”€ data_sync.py            # æ•°æ®åŒæ­¥æ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ scheduler.py            # å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
â””â”€â”€ supabase_client.py      # Supabaseæ•°æ®åº“å®¢æˆ·ç«¯(å·²å­˜åœ¨)

é…ç½®æ–‡ä»¶:
â”œâ”€â”€ data_sync_config.json   # è°ƒåº¦é…ç½®
â”œâ”€â”€ .env                    # ç¯å¢ƒå˜é‡
â””â”€â”€ run_data_sync.py       # ä¸»ç¨‹åºå…¥å£
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### 1. TonghuasunDataClient (tonghuashun_client.py)
- å°è£…åŒèŠ±é¡ºiFinD APIè°ƒç”¨
- æä¾›é¾™è™æ¦œæ•°æ®ã€æ—¥çº¿æ•°æ®è·å–æ–¹æ³•
- è‡ªåŠ¨ç™»å½•ç®¡ç†å’Œè¿æ¥ä¿æŒ

#### 2. DataSynchronizer (data_sync.py)
- æ•°æ®æ ¼å¼è½¬æ¢å’Œæ¸…ç†
- Supabaseæ•°æ®åº“å†™å…¥æ“ä½œ
- å¢é‡æ•°æ®æ£€æµ‹å’ŒåŒæ­¥

#### 3. DataScheduler (scheduler.py)
- å®šæ—¶ä»»åŠ¡ç®¡ç†
- ä»»åŠ¡æ‰§è¡Œå†å²è®°å½•
- å¼‚å¸¸å¤„ç†å’Œé‡è¯•é€»è¾‘

## ğŸ“Š æ•°æ®è¡¨ç»“æ„

### å¸­ä½æ•°æ®è¡¨ (seat_daily)
```sql
CREATE TABLE seat_daily (
    trade_date DATE,         -- äº¤æ˜“æ—¥æœŸ
    code VARCHAR(10),        -- è‚¡ç¥¨ä»£ç 
    name VARCHAR(50),        -- è‚¡ç¥¨åç§°
    seat_name VARCHAR(100),  -- å¸­ä½åç§°
    seat_type VARCHAR(20),   -- å¸­ä½ç±»å‹
    buy_amt DECIMAL(15,2),   -- ä¹°å…¥é‡‘é¢(ä¸‡å…ƒ)
    sell_amt DECIMAL(15,2),  -- å–å‡ºé‡‘é¢(ä¸‡å…ƒ)
    net_amt DECIMAL(15,2),   -- å‡€ä¹°å…¥é‡‘é¢(ä¸‡å…ƒ)
    reason VARCHAR(200)      -- ä¸Šæ¦œåŸå› 
);
```

### äº¤æ˜“æµå‘è¡¨ (trade_flow)
```sql
CREATE TABLE trade_flow (
    trade_date DATE,              -- äº¤æ˜“æ—¥æœŸ
    code VARCHAR(10),             -- è‚¡ç¥¨ä»£ç 
    name VARCHAR(50),             -- è‚¡ç¥¨åç§°
    lhb_buy DECIMAL(15,2),        -- é¾™è™æ¦œä¹°å…¥é¢
    lhb_sell DECIMAL(15,2),       -- é¾™è™æ¦œå–å‡ºé¢
    lhb_net_buy DECIMAL(15,2),    -- é¾™è™æ¦œå‡€ä¹°å…¥
    lhb_turnover_ratio DECIMAL(8,4), -- æˆäº¤å æ¯”
    reason VARCHAR(200)           -- ä¸Šæ¦œåŸå› 
);
```

### æ—¥çº¿æ•°æ®è¡¨ (daily_quotes)
```sql
CREATE TABLE daily_quotes (
    trade_date DATE,         -- äº¤æ˜“æ—¥æœŸ
    code VARCHAR(10),        -- è‚¡ç¥¨ä»£ç 
    open DECIMAL(10,2),      -- å¼€ç›˜ä»·
    high DECIMAL(10,2),      -- æœ€é«˜ä»·
    low DECIMAL(10,2),       -- æœ€ä½ä»·
    close DECIMAL(10,2),     -- æ”¶ç›˜ä»·
    volume BIGINT,           -- æˆäº¤é‡
    amount DECIMAL(18,2),    -- æˆäº¤é¢
    turnover DECIMAL(8,4),   -- æ¢æ‰‹ç‡
    pct_chg DECIMAL(8,4),    -- æ¶¨è·Œå¹…
    pe_ttm DECIMAL(10,2),    -- å¸‚ç›ˆç‡TTM
    pb DECIMAL(10,2),        -- å¸‚å‡€ç‡
    total_mv DECIMAL(18,2)   -- æ€»å¸‚å€¼
);
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. æµ‹è¯•ç¯å¢ƒ
```bash
python test_tonghuashun_setup.py
```

### 2. å¯åŠ¨è‡ªåŠ¨è°ƒåº¦å™¨
```bash
python run_data_sync.py scheduler
```

### 3. æ‰‹åŠ¨åŒæ­¥æ•°æ®
```bash
# åŒæ­¥ä»Šæ—¥æ•°æ®
python run_data_sync.py sync

# åŒæ­¥æŒ‡å®šæ—¥æœŸ
python run_data_sync.py sync --date 2025-09-08

# åªåŒæ­¥é¾™è™æ¦œæ•°æ®
python run_data_sync.py sync --type dragon_tiger

# åªåŒæ­¥æ—¥çº¿æ•°æ®
python run_data_sync.py sync --type daily_quotes
```

### 4. æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
```bash
python run_data_sync.py status
```

## âš™ï¸ é…ç½®è¯´æ˜

### data_sync_config.json é…ç½®é¡¹

```json
{
  "daily_sync_time": "20:00",      // æ¯æ—¥åŒæ­¥æ—¶é—´
  "weekend_sync": false,           // æ˜¯å¦å‘¨æœ«åŒæ­¥
  "retry_times": 3,               // å¤±è´¥é‡è¯•æ¬¡æ•°
  "retry_interval": 300,          // é‡è¯•é—´éš”(ç§’)
  "sync_days_back": 5,           // å›è¡¥å¤©æ•°
  "enable_dragon_tiger": true,    // å¯ç”¨é¾™è™æ¦œåŒæ­¥
  "enable_daily_quotes": true,    // å¯ç”¨æ—¥çº¿åŒæ­¥
  "batch_size": 50,              // æ‰¹å¤„ç†å¤§å°
  
  "data_source": {
    "tonghuashun": {
      "timeout": 30,             // APIè¶…æ—¶æ—¶é—´
      "request_interval": 0.1    // è¯·æ±‚é—´éš”
    }
  },
  
  "notification": {
    "enable": false,             // å¯ç”¨é€šçŸ¥
    "notify_on_failure": true    // å¤±è´¥æ—¶é€šçŸ¥
  }
}
```

## ğŸ“ˆ æ•°æ®æµç¨‹

```mermaid
graph TD
    A[å®šæ—¶è§¦å‘ 20:00] --> B[æ£€æŸ¥è¿æ¥çŠ¶æ€]
    B --> C[ç¡®å®šåŒæ­¥æ—¥æœŸèŒƒå›´]
    C --> D[è·å–è‚¡ç¥¨åˆ—è¡¨]
    D --> E{é€‰æ‹©æ•°æ®ç±»å‹}
    
    E -->|é¾™è™æ¦œ| F[è°ƒç”¨åŒèŠ±é¡ºAPI]
    E -->|æ—¥çº¿| G[è°ƒç”¨åŒèŠ±é¡ºAPI]
    
    F --> H[æ•°æ®æ ¼å¼è½¬æ¢]
    G --> H
    
    H --> I[æ•°æ®æ¸…ç†å’ŒéªŒè¯]
    I --> J[æ‰¹é‡å†™å…¥Supabase]
    J --> K[è®°å½•æ‰§è¡Œæ—¥å¿—]
    
    K -->|å¤±è´¥| L[é‡è¯•æœºåˆ¶]
    L --> F
    
    K -->|æˆåŠŸ| M[ä»»åŠ¡å®Œæˆ]
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—æ–‡ä»¶
- `data_sync.log`: è¯¦ç»†æ‰§è¡Œæ—¥å¿—
- `sync_log_YYYYMM.json`: ä»»åŠ¡æ‰§è¡Œå†å²è®°å½•

### çŠ¶æ€æ£€æŸ¥
```python
from data_service.data_sync import get_data_synchronizer

sync = get_data_synchronizer()
status = sync.get_sync_status()
print(f"è¿æ¥çŠ¶æ€: {status['connections']}")
print(f"æœ€ååŒæ­¥: {status['last_sync_dates']}")
```

### æ€§èƒ½æŒ‡æ ‡
- APIè°ƒç”¨é¢‘ç‡: 0.1ç§’/æ¬¡
- æ‰¹å¤„ç†å¤§å°: 1000æ¡/æ‰¹
- å†…å­˜ä½¿ç”¨: é€šå¸¸<500MB
- æ—¥åŒæ­¥æ—¶é—´: 5-15åˆ†é’Ÿ

## âš ï¸ æ³¨æ„äº‹é¡¹

### APIä½¿ç”¨é™åˆ¶
- åŒèŠ±é¡ºAPIæœ‰æ—¥è°ƒç”¨æ¬¡æ•°é™åˆ¶
- é¿å…å¹¶å‘è°ƒç”¨ï¼Œä¸¥æ ¼æ§åˆ¶è¯·æ±‚é¢‘ç‡
- ç™»å½•ä¼šè¯æœ‰æ—¶æ•ˆæ€§ï¼Œéœ€è¦è‡ªåŠ¨é‡è¿

### æ•°æ®è´¨é‡
- é¾™è™æ¦œæ•°æ®ä»…å·¥ä½œæ—¥äº§ç”Ÿ
- åœç‰Œè‚¡ç¥¨çš„æ—¥çº¿æ•°æ®å¯èƒ½ç¼ºå¤±
- æ–°è‚¡ä¸Šå¸‚åˆæœŸæ•°æ®å¯èƒ½ä¸å®Œæ•´

### ç³»ç»Ÿç¨³å®šæ€§
- ç½‘ç»œå¼‚å¸¸ä¼šè‡ªåŠ¨é‡è¯•
- æ•°æ®åº“è¿æ¥æ–­å¼€ä¼šè‡ªåŠ¨é‡è¿
- æ„å¤–ä¸­æ–­åå¯å®‰å…¨é‡å¯

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **åŒèŠ±é¡ºç™»å½•å¤±è´¥**
   - æ£€æŸ¥ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤iFinDç»ˆç«¯å·²å¯åŠ¨å¹¶æ¿€æ´»
   - æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€

2. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   - éªŒè¯SUPABASE_URLå’ŒSUPABASE_KEY
   - æ£€æŸ¥ç½‘ç»œé˜²ç«å¢™è®¾ç½®
   - ç¡®è®¤æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®

3. **æ•°æ®åŒæ­¥ç¼“æ…¢**
   - è°ƒæ•´batch_sizeå‚æ•°
   - æ£€æŸ¥ç½‘ç»œå¸¦å®½
   - è€ƒè™‘åˆ†æ‰¹å¤„ç†å†å²æ•°æ®

4. **é‡å¤æ•°æ®é—®é¢˜**
   - æ•°æ®åº“ä½¿ç”¨upsertæ“ä½œï¼Œè‡ªåŠ¨å¤„ç†é‡å¤
   - æ£€æŸ¥å”¯ä¸€é”®è®¾ç½®æ˜¯å¦æ­£ç¡®

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export LOG_LEVEL=DEBUG
python run_data_sync.py sync --date 2025-09-08
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ–‡æ¡£å‚è€ƒ
- åŒèŠ±é¡ºiFinD APIæ–‡æ¡£: `åŒèŠ±é¡ºæ•°æ®æ¥å£ç”¨æˆ·æ‰‹å†Œ-windows.pdf`
- Supabaseå®˜æ–¹æ–‡æ¡£: https://supabase.io/docs
- Python scheduleåº“: https://schedule.readthedocs.io/

### è”ç³»æ–¹å¼
å¦‚é‡æŠ€æœ¯é—®é¢˜ï¼Œè¯·æä¾›:
1. é”™è¯¯æ—¥å¿— (data_sync.log)
2. ç³»ç»Ÿç¯å¢ƒä¿¡æ¯
3. é…ç½®æ–‡ä»¶å†…å®¹
4. é—®é¢˜å¤ç°æ­¥éª¤

---

*è¯¥æ¨¡å—å·²å®Œæˆæ¶æ„è®¾è®¡å’Œæ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œå¯ç›´æ¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚*